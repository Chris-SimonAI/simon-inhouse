name: App Deploy (ECR â†’ ASG Rolling Restart)
on:
  workflow_run:
    workflows: ["Lint Code"]
    types: [completed]
    branches: [master]
permissions: { id-token: write, contents: read }
env:
  AWS_REGION: us-west-1
  AWS_ACCOUNT_ID: "461346075984"
  ECR_REPO: "meetsimon/web"
  IMAGE_TAG: ${{ github.sha }}
  ASG_NAME: "meet-simon-min-asg"
jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::461346075984:role/gh-oidc-app-deploy
      - uses: aws-actions/amazon-ecr-login@v2
      - name: Set up buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build & Push Docker Image
        env:
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY }}
          NEXT_PUBLIC_RUM_APP_MONITOR_ID: ${{ secrets.NEXT_PUBLIC_RUM_APP_MONITOR_ID }}
          NEXT_PUBLIC_AWS_REGION: ${{ secrets.NEXT_PUBLIC_AWS_REGION }}
          NEXT_PUBLIC_RUM_IDENTITY_POOL_ID: ${{ secrets.NEXT_PUBLIC_RUM_IDENTITY_POOL_ID }}
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" \
            --build-arg NEXT_PUBLIC_APP_URL="$NEXT_PUBLIC_APP_URL" \
            --build-arg NEXT_PUBLIC_GOOGLE_MAPS_API_KEY="$NEXT_PUBLIC_GOOGLE_MAPS_API_KEY" \
            --build-arg NEXT_PUBLIC_RUM_APP_MONITOR_ID="$NEXT_PUBLIC_RUM_APP_MONITOR_ID" \
            --build-arg NEXT_PUBLIC_AWS_REGION="$NEXT_PUBLIC_AWS_REGION" \
            --build-arg NEXT_PUBLIC_RUM_IDENTITY_POOL_ID="$NEXT_PUBLIC_RUM_IDENTITY_POOL_ID" \
            -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$IMAGE_TAG \
            -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:latest \
            --push .
          echo "âœ… Image pushed: $IMAGE_TAG"
      
      - name: Trigger ASG Rolling Restart
        run: |
          echo "ðŸ”„ Starting instance refresh for ASG: $ASG_NAME"
          
          # Start instance refresh (uses ASG's configured preferences)
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "$ASG_NAME"
          
          echo "âœ… Instance refresh started!"